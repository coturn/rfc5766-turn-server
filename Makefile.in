
LIBEVENT_INCLUDE = -I${PREFIX}/include/ -I/usr/local/include/

INCFLAGS = -Isrc/apps/common -Isrc/server -Isrc/client -Isrc/client++ ${LIBEVENT_INCLUDE} 

CFLAGS += ${INCFLAGS}

MAKE_DEPS = Makefile

LIBCLIENTTURN_HEADERS = src/ns_turn_defs.h src/client++/TurnMsgLib.h src/client/ns_turn_ioaddr.h src/client/ns_turn_msg.h src/client/ns_turn_msg_defs.h src/client/ns_turn_msg_addr.h 
LIBCLIENTTURN_DEPS = ${LIBCLIENTTURN_HEADERS} ${MAKE_DEPS} 
LIBCLIENTTURN_OBJS = build/obj/ns_turn_ioaddr.o build/obj/ns_turn_msg_addr.o build/obj/ns_turn_msg.o 

LIBSERVERTURN_HEADERS = ${LIBCLIENTTURN_HEADERS} src/server/ns_turn_allocation.h src/server/ns_turn_ioalib.h src/server/ns_turn_khash.h src/server/ns_turn_maps_rtcp.h src/server/ns_turn_maps.h src/server/ns_turn_server.h src/server/ns_turn_session.h 
LIBSERVERTURN_DEPS = ${LIBSERVERTURN_HEADERS} ${MAKE_DEPS} 
LIBSERVERTURN_OBJS = ${LIBCLIENTTURN_OBJS} build/obj/ns_turn_allocation.o build/obj/ns_turn_maps_rtcp.o build/obj/ns_turn_maps.o build/obj/ns_turn_server.o

COMMON_DEPS = ${LIBCLIENTTURN_DEPS} src/apps/common/apputils.c src/apps/common/ns_turn_utils.c src/apps/common/apputils.h src/apps/common/ns_turn_utils.h src/apps/common/stun_buffer.c src/apps/common/stun_buffer.h
COMMON_MODS = src/apps/common/apputils.c src/apps/common/ns_turn_utils.c src/apps/common/stun_buffer.c

IMPL_DEPS = src/apps/relay/ns_ioalib_impl.h src/apps/relay/ns_ioalib_engine_impl.c src/apps/relay/turn_ports.h src/apps/relay/turn_ports.c
IMPL_MODS = src/apps/relay/ns_ioalib_engine_impl.c src/apps/relay/turn_ports.c

all:	bin/turnutils_stunclient bin/turnutils_rfc5769check bin/turnutils_uclient bin/turnserver bin/turnutils_peer lib/libturnclient.a include/turn/ns_turn_defs.h

test:	check

check:	bin/turnutils_rfc5769check
	bin/turnutils_rfc5769check

include/turn/ns_turn_defs.h:	src/ns_turn_defs.h
	${RMCMD} include
	${MKBUILDDIR} include/turn/client
	cp -pf src/client/*.h include/turn/client/
	cp -pf src/client++/*.h include/turn/client/
	cp -pf src/ns_turn_defs.h include/turn/

bin/turnutils_uclient:	${COMMON_DEPS} src/apps/uclient/session.h lib/libturnclient.a src/apps/uclient/mainuclient.c src/apps/uclient/uclient.c src/apps/uclient/uclient.h src/apps/uclient/startuclient.c src/apps/uclient/startuclient.h
	${MKBUILDDIR} bin
	${CC} ${CPPFLAGS} ${CFLAGS} src/apps/uclient/uclient.c src/apps/uclient/startuclient.c src/apps/uclient/mainuclient.c ${COMMON_MODS} -o $@ -Llib -lturnclient -Llib ${LDFLAGS}  

bin/turnutils_stunclient:	${COMMON_DEPS} lib/libturnclient.a src/apps/stunclient/stunclient.c 
	pwd
	${MKBUILDDIR} bin
	${CC} ${CPPFLAGS} ${CFLAGS} src/apps/stunclient/stunclient.c ${COMMON_MODS} -o $@ -Llib -lturnclient -Llib ${LDFLAGS}   

bin/turnutils_rfc5769check:	${COMMON_DEPS} lib/libturnclient.a src/apps/rfc5769/rfc5769check.c 
	pwd
	${MKBUILDDIR} bin
	${CC} ${CPPFLAGS} ${CFLAGS} src/apps/rfc5769/rfc5769check.c ${COMMON_MODS} -o $@ -Llib -lturnclient -Llib ${LDFLAGS} 

bin/turnserver:	${COMMON_DEPS} ${IMPL_DEPS} ${LIBSERVERTURN_OBJS} ${LIBSERVERTURN_DEPS} lib/libturnclient.a src/apps/relay/mainrelay.c src/apps/relay/userdb.c src/apps/relay/userdb.h src/apps/relay/tls_listener.h src/apps/relay/tls_listener.c src/apps/relay/dtls_listener.h src/apps/relay/dtls_listener.c
	${MKBUILDDIR} bin
	${RMCMD} bin/turnadmin
	${CC} ${CPPFLAGS} ${CFLAGS} ${DBCFLAGS} ${IMPL_MODS} -Ilib src/apps/relay/mainrelay.c src/apps/relay/userdb.c src/apps/relay/tls_listener.c src/apps/relay/dtls_listener.c ${COMMON_MODS} ${LIBSERVERTURN_OBJS} -o $@ ${DBLIBS} ${LDFLAGS} 
	cd bin; ln -s turnserver turnadmin  

bin/turnutils_peer:	${COMMON_DEPS} ${LIBCLIENTTURN_OBJS} ${LIBCLIENTTURN_DEPS} lib/libturnclient.a src/apps/peer/mainudpserver.c src/apps/peer/udpserver.h src/apps/peer/udpserver.c
	${MKBUILDDIR} bin
	${CC} ${CPPFLAGS} ${CFLAGS} src/apps/peer/mainudpserver.c src/apps/peer/udpserver.c ${COMMON_MODS} -o $@ -Llib -lturnclient -Llib ${LDFLAGS}  

### Client Library:

lib/libturnclient.a:	${LIBCLIENTTURN_OBJS} ${LIBCLIENTTURN_DEPS}
	${MKBUILDDIR} lib
	${ARCHIVERCMD} $@ ${LIBCLIENTTURN_OBJS}

build/obj/ns_turn_ioaddr.o:	src/client/ns_turn_ioaddr.c ${LUBCLIENTTURN_DEPS}
	${MKBUILDDIR} build/obj
	${CC} ${CPPFLAGS} ${CFLAGS} -c src/client/ns_turn_ioaddr.c -o $@

build/obj/ns_turn_msg_addr.o:	src/client/ns_turn_msg_addr.c ${LUBCLIENTTURN_DEPS}
	${MKBUILDDIR} build/obj
	${CC} ${CPPFLAGS} ${CFLAGS} -c src/client/ns_turn_msg_addr.c -o $@

build/obj/ns_turn_msg.o:	src/client/ns_turn_msg.c ${LUBCLIENTTURN_DEPS}
	${MKBUILDDIR} build/obj
	${CC} ${CPPFLAGS} ${CFLAGS} -c src/client/ns_turn_msg.c -o $@

### Server Obj:

build/obj/ns_turn_server.o:	src/server/ns_turn_server.c ${LUBTURN_DEPS}
	${MKBUILDDIR} build/obj
	${CC} ${CPPFLAGS} ${CFLAGS} -c src/server/ns_turn_server.c -o $@

build/obj/ns_turn_maps_rtcp.o:	src/server/ns_turn_maps_rtcp.c ${LUBTURN_DEPS}
	${MKBUILDDIR} build/obj
	${CC} ${CPPFLAGS} ${CFLAGS} -c src/server/ns_turn_maps_rtcp.c -o $@

build/obj/ns_turn_maps.o:	src/server/ns_turn_maps.c ${LUBTURN_DEPS}
	${MKBUILDDIR} build/obj
	${CC} ${CPPFLAGS} ${CFLAGS} -c src/server/ns_turn_maps.c -o $@

build/obj/ns_turn_allocation.o:	src/server/ns_turn_allocation.c ${LUBTURN_DEPS}
	${MKBUILDDIR} build/obj
	${CC} ${CPPFLAGS} ${CFLAGS} -c src/server/ns_turn_allocation.c -o $@

### Clean all:

clean:	
	${RMCMD} bin build lib obj *bak *~ */*~ */*/*~ */*/*/*~ *core include Makefile tmp

distclean:	clean

### Install all:

install:	all ${MAKE_DEPS}
	${MKDIR} ${PREFIX}
	${MKDIR} ${PREFIX}/bin
	${MKDIR} ${MANPREFIX}/man/man1
	${MKDIR} ${PREFIX}/etc
	${MKDIR} ${LIBDIR}
	${MKDIR} ${EXAMPLESDIR}
	${MKDIR} ${DOCSDIR}
	${MKDIR} ${SCHEMADIR}
	${MKDIR} ${TURNINCLUDEDIR}
	${INSTALL_PROGRAM} bin/turnserver ${PREFIX}/bin/
	${INSTALL_PROGRAM} bin/turnadmin ${PREFIX}/bin/
	${INSTALL_PROGRAM} bin/turnutils_uclient ${PREFIX}/bin/
	${INSTALL_PROGRAM} bin/turnutils_peer ${PREFIX}/bin/
	${INSTALL_PROGRAM} bin/turnutils_stunclient ${PREFIX}/bin/
	${INSTALL_PROGRAM} bin/turnutils_rfc5769check ${PREFIX}/bin/
	${INSTALL_MAN} man/man1/turnserver.1 ${MANPREFIX}/man/man1/
	${INSTALL_MAN} man/man1/turnadmin.1 ${MANPREFIX}/man/man1/
	${INSTALL_MAN} man/man1/turnutils.1 ${MANPREFIX}/man/man1/
	${INSTALL_MAN} man/man1/turnutils_uclient.1 ${MANPREFIX}/man/man1/
	${INSTALL_MAN} man/man1/turnutils_rfc5769check.1 ${MANPREFIX}/man/man1/
	${INSTALL_MAN} man/man1/turnutils_stunclient.1 ${MANPREFIX}/man/man1/
	${INSTALL_MAN} man/man1/turnutils_peer.1 ${MANPREFIX}/man/man1/
	${INSTALL_STATIC_LIB} lib/libturnclient.a ${LIBDIR}
	${INSTALL_DIR} docs/html ${DOCSDIR}
	${INSTALL_DATA} docs/TURNServerRESTAPI.pdf ${DOCSDIR}
	${INSTALL_DATA} docs/TurnNetworks.pdf ${DOCSDIR}
	${INSTALL_DATA} README.turnserver ${DOCSDIR}
	${INSTALL_DATA} README.turnadmin ${DOCSDIR}
	${INSTALL_DATA} README.turnutils ${DOCSDIR}
	${INSTALL_DATA} INSTALL ${DOCSDIR}
	${INSTALL_DATA} postinstall.txt ${DOCSDIR}
	${INSTALL_DATA} turndb/schema.sql ${DOCSDIR}
	${INSTALL_DATA} turndb/schema.sql ${SCHEMADIR}
	${INSTALL_DATA} examples/etc/turnserver.conf ${PREFIX}/etc/turnserver.conf.default
	${INSTALL_DATA} examples/etc/turnuserdb.conf ${PREFIX}/etc/turnuserdb.conf.default
	${INSTALL_DIR} examples/etc ${EXAMPLESDIR}
	${INSTALL_DIR} examples/scripts ${EXAMPLESDIR}
	${INSTALL_DIR} include/turn/client ${TURNINCLUDEDIR}
	${INSTALL_DATA} include/turn/ns_turn_defs.h ${TURNINCLUDEDIR}
	${MORECMD} ${DOCSDIR}/postinstall.txt

deinstall:	${MAKE_DEPS}
	${RMCMD} ${DOCSDIR}
	${RMCMD} ${SCHEMADIR}
	${RMCMD} ${PREFIX}/bin/turnserver
	${RMCMD} ${PREFIX}/bin/turnadmin
	${RMCMD} ${PREFIX}/bin/turnutils_peer
	${RMCMD} ${PREFIX}/bin/turnutils_uclient
	${RMCMD} ${PREFIX}/bin/turnutils_rfc5769check
	${RMCMD} ${PREFIX}/bin/turnutils_stunclient
	${RMCMD} ${MANPREFIX}/man/man1/turnserver.1
	${RMCMD} ${MANPREFIX}/man/man1/turnadmin.1
	${RMCMD} ${MANPREFIX}/man/man1/turnutils.1
	${RMCMD} ${LIBDIR}/libturnclient.a
	${RMCMD} ${EXAMPLESDIR}/
	${RMCMD} ${PREFIX}/etc/turnserver.conf.default
	${RMCMD} ${PREFIX}/etc/turnuserdb.conf.default
	${RMCMD} ${TURNINCLUDEDIR}

uninstall:	deinstall

reinstall:	deinstall install


